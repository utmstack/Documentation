# Alerts API Documentation

## Overview

This endpoint retrieves alerts from UTMStack's Elasticsearch index.  
It supports advanced filtering, pagination, and sorting, allowing analysts to query alerts within specific time ranges or by defined conditions.

> [!NOTE]
> **Authorization Required:** All requests must include a valid API Key in the header `utm-api-key`.
---
## Query Parameters

- **page** (integer, required): Current page number (starts at 1)
- **size** (integer, required): Number of results per page (e.g., 25)
- **top** (integer, required): Maximum number of records to retrieve (e.g., 100000000)
- **indexPattern** (string, required): Elasticsearch index pattern (e.g., `v11-alert-*`)
- **sort** (string, optional): Sorting field and direction (e.g., `@timestamp,desc`)
---
## Request Body

The request body is a JSON array of filter definitions used to refine the search.

### Example Filter Payload

```json
[
  { "field": "status", "operator": "IS_NOT", "value": 1 },
  { "field": "tags", "operator": "IS_NOT", "value": "False positive" },
  { "field": "@timestamp", "operator": "IS_BETWEEN", "value": ["now-7d", "now"] }
]
```

## Request & Response Examples

```javascript
curl -X POST "https://demo.utmstack.com/api/elasticsearch/search?page=1&size=25&top=100000000&indexPattern=v11-alert-*&sort=@timestamp,desc" 
  -H "utm-api-key: <your_api_key>" 
  -H "Content-Type: application/json" 
  -d '[
    {"field": "status", "operator": "IS_NOT", "value": 1},
    {"field": "tags", "operator": "IS_NOT", "value": "False positive"},
    {"field": "@timestamp", "operator": "IS_BETWEEN", "value": ["now-7d", "now"]}
  ]'
```

```json
[
  {
    "severity": 3,
    "severityLabel": "High",
    "status": 2,
    "statusLabel": "Open",
    "name": "Windows: Multiple Windows logon failures",
    "description": "Adversaries may use brute force techniques to gain access to accounts when passwords are unknown or when password hashes are obtained.",
    "tactic": "Brute Force",
    "category": "Potentially Malicious Activity",
    "dataSource": "dev-wsrv-2016",
    "@timestamp": "2024-10-15T10:30:00.000Z",
    "source": {
      "ip": "192.168.1.100",
      "hostname": "workstation-01"
    },
    "destination": {
      "ip": "192.168.1.10",
      "hostname": "domain-controller"
    }
  }
]
```

### Code Examples

<CodeGroup>

```javascript Node.js
import axios from 'axios';

const searchAlerts = async () => {
  const url = 'https://demo.utmstack.com/api/elasticsearch/search';
  const params = {
    page: 1,
    size: 25,
    top: 100000000,
    indexPattern: 'v11-alert-*',
    sort: '@timestamp,desc'
  };
  
  const filters = [
    { field: 'status', operator: 'IS_NOT', value: 1 },
    { field: 'tags', operator: 'IS_NOT', value: 'False positive' },
    { field: '@timestamp', operator: 'IS_BETWEEN', value: ['now-7d', 'now'] }
  ];

  try {
    const response = await axios.post(url, filters, {
      params,
      headers: {
        'utm-api-key': '<your_api_key>',
        'Content-Type': 'application/json'
      }
    });
    
    return response.data;
  } catch (error) {
    console.error('Error fetching alerts:', error);
  }
};
```

```python Python
import requests

def search_alerts():
    url = "https://demo.utmstack.com/api/elasticsearch/search"
    
    params = {
        "page": 1,
        "size": 25,
        "top": 100000000,
        "indexPattern": "v11-alert-*",
        "sort": "@timestamp,desc"
    }
    
    filters = [
        {"field": "status", "operator": "IS_NOT", "value": 1},
        {"field": "tags", "operator": "IS_NOT", "value": "False positive"},
        {"field": "@timestamp", "operator": "IS_BETWEEN", "value": ["now-7d", "now"]}
    ]
    
    headers = {
        "utm-api-key": "<your_api_key>",
        "Content-Type": "application/json"
    }
    
    response = requests.post(url, json=filters, params=params, headers=headers)
    return response.json()
```

</CodeGroup>
---
## Response Details

Returns a JSON array of alert objects. Each alert includes metadata, source/destination information, and contextual details.

### Complete Response Structure

<Tabs>
  <Tab title="Success Response">

    ```json
    [
      {
        "severity": 2,
        "severityLabel": "Medium",
        "status": 2,
        "statusLabel": "Open",
        "TagRulesApplied": null,
        "notes": "",
        "dataType": "wineventlog",
        "name": "Windows: Multiple Windows logon failures",
        "description": "Adversaries may use brute force techniques to gain access to accounts when passwords are unknown or when password hashes are obtained.",
        "solution": "Set account lockout policies after a certain number of failed login attempts to prevent passwords from being guessed. Use multi-factor authentication.",
        "statusObservation": "This alert has been evaluated by the tag rules engine",
        "tactic": "Brute Force",
        "category": "Potentially Malicious Activity",
        "dataSource": "dev-wsrv-2016",
        "tags": null,
        "@timestamp": "2024-10-15T10:30:00.000Z",
        "source": {
          "ip": "192.168.1.100",
          "hostname": "workstation-01"
        },
        "destination": {
          "ip": "192.168.1.10",
          "hostname": "domain-controller"
        }
      }
    ]
    ```

  </Tab>

  <Tab title="Empty Response">

    ```json
    []
    ```

  </Tab>

  <Tab title="Error Response">

    ```json
    {
      "error": "Invalid filter syntax",
      "message": "Field 'invalid_field' is not recognized",
      "timestamp": "2024-10-16T10:30:00.000Z",
      "status": 400
    }
    ```

  </Tab>

</Tabs>

### Response Fields

- **severity** (integer): Alert severity level (1-5, where 5 is highest)
- **severityLabel** (string): Human-readable severity label (Low, Medium, High, Critical)
- **status** (integer): Alert status code (1=Ignored, 2=Open, 3=In Review, 5=Completed)
- **statusLabel** (string): Human-readable status label
- **name** (string): Alert rule name or title
- **description** (string): Detailed description of the security event
- **solution** (string): Recommended remediation steps
- **tactic** (string): MITRE ATT&CK tactic classification
- **category** (string): Alert category classification
- **dataSource** (string): Source system that generated the alert
- **@timestamp** (string): ISO 8601 timestamp when the alert was created
---
## Filter Operators

<Accordion multiple={true}>
  <AccordionTab title="Accordion Item" >

    - **IS**: Exact match
    - **IS_NOT**: Not equal to
    - **CONTAINS**: Contains substring
    - **STARTS_WITH**: Begins with value
    - **ENDS_WITH**: Ends with value

  </AccordionTab>

  <AccordionTab title="Accordion Item" >

    - **GREATER_THAN**: Greater than value
    - **LESS_THAN**: Less than value
    - **GREATER_EQUAL**: Greater than or equal to
    - **LESS_EQUAL**: Less than or equal to

  </AccordionTab>

  <AccordionTab title="Accordion Item" >

    - **IS_BETWEEN**: Between two values (requires array)
    - **IS_IN**: Value in list (requires array)
    - **IS_NOT_IN**: Value not in list (requires array)

  </AccordionTab>

</Accordion>
---
## Common Filter Examples

### Filter by Severity

```json
[
  { "field": "severity", "operator": "GREATER_EQUAL", "value": 3 }
]
```

### Filter by Time Range (Last 24 hours)

```json
[
  { "field": "@timestamp", "operator": "IS_BETWEEN", "value": ["now-24h", "now"] }
]
```

### Filter by Multiple Statuses

```json
[
  { "field": "status", "operator": "IS_IN", "value": [2, 3] }
]
```

### Filter by Data Source

```json
[
  { "field": "dataSource", "operator": "CONTAINS", "value": "windows" }
]
```
---
## Status Codes

- **200** (OK): Search completed successfully. Returns array of alerts.
- **400** (Bad Request): Invalid request parameters or malformed filter syntax.
- **401** (Unauthorized): Missing or invalid Bearer token.
- **403** (Forbidden): Insufficient permissions to access alerts.
- **500** (Internal Server Error): Elasticsearch service error or internal server issue.
---
## Pagination

The API supports pagination through the `page` and `size` parameters:

- **page**: Current page number (1-based)
- **size**: Number of results per page
- **top**: Maximum total results to consider

> [!TIP]
> For optimal performance, use reasonable `size` values (25-100) and implement client-side pagination for large result sets.
---
## Performance Considerations

> [!WARNING]
> **Performance Tips:**
> - Use specific time ranges to limit search scope
> - Apply filters to reduce the result set size
> - Avoid very large `top` values unless necessary
> - Consider using field-specific filters for better query performance
